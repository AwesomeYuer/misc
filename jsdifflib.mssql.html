<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<title>jsdifflib demo</title>
	<link rel="stylesheet" type="text/css" href="scripts/diffview.css"/>
	<script type="text/javascript" src="scripts/diffview.js"></script>
    <script type="text/javascript" src="scripts/difflib.js"></script>
    <script src="Scripts/knockout-3.4.2.debug.js" type="text/javascript"></script>
    <script src="Scripts/jquery-3.3.1.js" type="text/javascript"></script>
<style type="text/css">
body {
	font-size: 12px;
	font-family: Sans-Serif;
}
h2 {
	margin: 0.5em 0 0.1em;
	text-align: center;
}
.top {
	text-align: center;
}
.textInput {
	display: block;
	width: 49%;
	float: left;
}
textarea {
	width:100%;
	height:300px;
}
label:hover {
	text-decoration: underline;
	cursor: pointer;
}
.spacer {
	margin-left: 10px;
}
.viewType {
	font-size: 16px;
	clear: both;
	text-align: center;
	padding: 1em;
}
#diffoutput {
	width: 100%;
}
</style>

<script type="text/javascript">
var baseUrl = "http://localhost:5000";
baseUrl = "http://sops-sp-03.eastus.cloudapp.azure.com:8001";
function GetObjectsTexts() {
    //debugger;
    var left = vm.SelectedItems()[0].ID;
    var right = vm.SelectedItems()[1].ID;
    var ids = left + ',' + right;
    var url = baseUrl + "/api/StoreProcedureExecutor/mssql2/zsp_GetObjectTextHistory/Outputs/ResultSets/1/Rows?ids=" + ids;
    $.getJSON(
        url
        , function (data) {
            diffUsingJS(0, 
                    { Name:data[0].ObjectName ,Text: data[0].TSQLCommand, TimeStamp: data[0].PostTime }, 
                    { Name:data[1].ObjectName ,Text: data[1].TSQLCommand, TimeStamp: data[1].PostTime }
            );
        }
    );
}

function SelectedLeft() {
    alert(vm.SelectedItem().PostTime);

}


function diffUsingJS(viewType, baseObject, newObject) {
    "use strict";
    var byId = function (id) { return document.getElementById(id); },
		base = difflib.stringAsLines(baseObject.Text),
		newtxt = difflib.stringAsLines(newObject.Text),
		sm = new difflib.SequenceMatcher(base, newtxt),
		opcodes = sm.get_opcodes(),
		diffoutputdiv = byId("diffoutput"),
		contextSize = byId("contextSize").value;

	diffoutputdiv.innerHTML = "";
	contextSize = contextSize || null;

	diffoutputdiv.appendChild(diffview.buildView({
		baseTextLines: base,
		newTextLines: newtxt,
		opcodes: opcodes,
		baseTextName: baseObject.Name + '\n' + baseObject.TimeStamp,
		newTextName: newObject.Name + '\n' + newObject.TimeStamp,
		contextSize: contextSize,
		viewType: viewType
	}));
}

</script>
</head>
<body>
<input id="search" type="text" />
<button onclick="GetList()">search</button>
<button onclick="Clear()">clear</button>
        <div class="container">
                <div class="form-group">
                    <label>Search Result:</label><br />
                    <select size="20"
                        style="width:40%;height: 300px;"
                        data-bind="options: Items,
                                    optionsText: 'OptionText',
                                    selectedOptions: SelectedItems
                                "
                    >
                    </select>
                    <select size="20"
                    style="width:40%;height: 300px;"
                    data-bind="options: ChildrenItems,
                                optionsText: 'OptionText',
                                selectedOptions: SelectedChildrenItems,
                                optionsAfterRender: SetChildItemOptionDisable"
                            "
                    >
                    </select>
                </div>
            </div>  
            <div >
                <Table width="80%">
                    <TR>
                        <td align="right"><button onclick="SelectedLeft()">Left</button></td>
                        <td align="left"><button>Right</button></td>
                            
                            
                    </TR>
                </Table>          
            </div>
	<div class="top">
		<strong>Context size (optional):</strong> <input type="text" id="contextSize" value="" />
    </div>
    
    <div class="viewType">
            <input type="button" value="compare" onclick="GetObjectsTexts();" />
            <!-- &nbsp; &nbsp;
            <input type="radio" name="_viewtype" id="inline" onclick="diffUsingJS(1);" /> <label for="inline">Inline Diff</label> -->
    </div>
    <div id="diffoutput"> </div>
    <script>
    var viewModel = function (data) {
            var self = this;
            this.Items = ko.observableArray(data);
            this.SelectedItems = ko.observable([]);
            this.SelectedItem = ko.computed(function() {
                    return this.SelectedItems()[0];
                }, this);
            this.ChildrenItems = ko.computed(function() {
                    return this.Items().filter(function(x){
                        var r = false;
                        r = self.SelectedItem() != undefined;
                        if (r) {
                            var xx = self.SelectedItem();
                            x.DisableAsChild(x.ID == xx.ID);
                            r = (x.ObjectName == xx.ObjectName);
                        }
                        return  r ;
                    })
                }, this);
            this.SelectedChildrenItems = ko.observable([]);
            this.SelectedChildItem = ko.computed(function() {
                    return this.SelectedChildrenItems()[0];
                }, this);
            this.SetChildItemOptionDisable = function(option, item) {
                    ko.applyBindingsToNode(option, {disable: item.DisableAsChild}, item);
                }
        

        };
        var vm = new viewModel([]);
        ko.applyBindings(vm);
        
        function Clear() {
            vm.Items.removeAll();
        }

        function GetList() {
            //jsonp cross domain
            var search = document.getElementById("search").value;
            var url = baseUrl + "/api/StoreProcedureExecutor/mssql2/zsp_getobjecthistory/Outputs/ResultSets/1/Rows?searchobjectname=" + search;
            $.getJSON(
                url
                , function (data) {
                    //alert(data);
                        //vm.Items.removeAll();
                        $.each(data, function (i, item) {
                                    var items = vm.Items;
                                    var found = items.find(function(x){
                                            return x.ID == item.ID;
                                        });
                                    if (found != undefined){
                                        item.OptionText = item.ObjectName + '(' + item.ID +')' + ' @ ' + item.PostTime + ' => ' + item.HostName;
                                        item.DisableAsChild = ko.observable(false);
                                        vm.Items.push(item);
                                    }
                                }
                            );
                }
            );
        }
    </script>
</body>
</html>
